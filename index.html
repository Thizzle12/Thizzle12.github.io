<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Income USA</title>
		<script type="text/javascript" src="../d3.js"></script>
		<script src="https://unpkg.com/d3-simple-slider@0.2.1/build/d3-simple-slider.js"></script>
	</head>
	<body>
    <style>

    .selected {
      fill: red;
      stroke: brown;
    }

		#map{
			display:inline-block;
		}

		#bar-chart{
			display:inline-block;
		}

    </style>

    <div class="row align-items-center">
      <div class="col-sm-2">
        <p id="value3"></p>
      </div>
      <div class="col-sm">
        <div id="slider"></div>
      </div>
    </div>
    <script type="text/javascript">

		var dataset, bData;
		var padding = 50;
		var bw = 800;
		var bh = 400;
		var h2 = 500;
		var w2 = 800;
		var year = '2007';
		var minValue, maxValue;
		var barPadding = 1;
    var projection = d3.geoAlbersUsa()
                        .translate([w2/2, h2/2])
                        .scale([1000]);

    var path = d3.geoPath(projection)
    var svg;
    var color = d3.scaleOrdinal(d3.schemeCategory10);
		var barDataset, xScale, yScale, xAxis, yAxis;


		var mapsvg = d3.select("body")
			.append("svg")
			.attr("id", "map")
			.attr("height", h2)
			.attr("width", w2)
      .attr("background" , "blue");

		var barSvg = d3.select("body")
										.append("svg")
										.attr("id", "bar-chart")
										.attr("height", bh)
										.attr("width", bw)

		var sliderData = d3.range(0, 11).map(function (d) { return new Date(2007 + d, 10, 3); });
		var slider = d3.sliderHorizontal()
	 	 .min(d3.min(sliderData))
	 	 .max(d3.max(sliderData))
	 	 .step(1000 * 60 * 60 * 24 * 365)
	 	 .width(400)
	 	 .tickFormat(d3.timeFormat('%Y'))
	 	 .tickValues(sliderData)
	 	 .on('onchange', val => {

	 		 d3.select("p#value3").text(d3.timeFormat('%Y')(val));
			 year = d3.timeFormat('%Y')(val);
			 updatePaths();

	 	 });

	  var g = d3.select("div#slider").append("svg")
	 	 .attr("width", 500)
	 	 .attr("height", 100)
	 	 .append("g")
	 	 .attr("transform", "translate(30,30)");

	  g.call(slider);

	  d3.select("p#value3").text(d3.timeFormat('%Y')(slider.value()));
	  d3.select("a#setValue3").on("click", () => slider.value(new Date(2007, 10, 17)));


		function makeVis(){


			bData = barDataset.filter(function(d){ // filter rows so only lineCode 3 persists
				if(d.LineCode == 3){
					return true;
				}
				return false;
			});
			xScale = d3.scaleLinear()
										.domain([0, 50])
										.range([0, bw])

			yScale = d3.scaleLinear()
								.domain([0, d3.max(bData, function(d){
									return selectYear(year, d);
								})])   // values between 0 and 100
								 .range([ bh+20, padding+20]);

			yAxis = d3.axisLeft()
					.tickSize(0, 5)
					.scale(yScale);

			// define the y axis
			xAxis = d3.axisBottom()
					 .tickSize(5, 0)
					 .tickFormat(d3.timeFormat("%d/%m/%y"))
					 .scale(xScale);
			// console.log(d3.max(bData, function(d){ return selectYear(year, d)}))

			barSvg.selectAll("rect")
						.data(bData)
						.enter()
						.append("rect")
						.attr("x", function(d, i){
							  return i*((bw-padding)/bData.length)+padding;
						})
						.attr("y", function(d){
							  return yScale(selectYear(year, d))-padding;
						})
						.attr("width", (bw/bData.length-3))
						.attr("height", function(d, i){
							return bh-yScale(selectYear(year, d));
						});

			var ticks = bData.map(function(d) { return d.GeoName; });
			var x0 = d3.scaleBand()
					.rangeRound([0, bw-30])
			x0.domain(bData.map(function(d) { return d.GeoName; }));

			barSvg.append("g")
						.attr("class", "axis")
						.attr("transform", "translate(" + 40 + ","+ (bh-padding) +")")
						.call(d3.axisBottom(x0))
						.selectAll("text")
						.attr("transform","rotate(-50)")
						.attr("text-anchor","end");;

			barSvg.append("g")
          .attr("class", "axis yaxis")
					.attr("transform", "translate("+ 40 + ", " + -padding +  ")")
          .call(yAxis)
        	.append("text")
          .attr("fill", "#000")
          .attr("font-weight", "bold")
          .attr("text-anchor", "start")
          .text("Per capita personal income (dollars)");



		}

		function coloringStates(stateIncome){
			return ((stateIncome-minValue)*255/(maxValue-minValue));
		}

		function selectYear(newYear, data){
			switch(newYear){
				case '2007':
					return data.y2007;
					break;
				case '2008':
					return data.y2008;
					break;
				case '2009':
					return data.y2009;
					break;
				case '2010':
					return data.y2010;
					break;
				case '2011':
					return data.y2011;
					break;
				case '2012':
					return data.y2012;
					break;
				case '2013':
					return data.y2013;
					break;
				case '2014':
					return data.y2014;
					break;
				case '2015':
					return data.y2015;
					break;
				case '2016':
					return data.y2016;
					break;
				case '2017':
					return data.y2017;
					break;
				default:
					return data.y2017;
					break;
			}
		}

		function updatePaths(){

			maxValue = 0;
			minValue = 0;
			var barChartData = [];
			for(var i = 0; i < dataset.length; i++){
			 if(dataset[i].LineCode === "3"){
				 if(maxValue < selectYear(year, dataset[i])){
					 maxValue = selectYear(year, dataset[i]);
				 }if(minValue > selectYear(year, dataset[i])){
					 minValue = selectYear(year, dataset[i]);
				 }
			 }
		 	}
			 for(var i = 0; i < dataset.length; i++){
				 if(dataset[i].LineCode === "3"){

					 barChartData.push(selectYear(year, dataset[i]));
					 // console.log(dataset[i].GeoName)
					 var stateName = dataset[i].GeoName;
					 if(stateName.indexOf(' ') >= 0){
						 stateName = stateName.replace(/\s/g, "_");
					 }
					 mapsvg.select("#" + stateName)
							 .data(dataset)
							 .attr("fill", "rgb(0, " + coloringStates(selectYear(year, dataset[i])) + ", 0)")
							 .append("title");


						mapsvg.select("#" + stateName)
									.select("title")
									.text(function(d){
	 								 return "State: " + dataset[i].GeoName + ", Average Income: " + selectYear(year, dataset[i]) + " $"
	 							 });


				 }
			 }
			 updateBarChart();
		}

		function updateBarChart(){

		yScale = d3.scaleLinear()
							.domain([0, d3.max(bData, function(d){
								return selectYear(year, d);
							})])   // values between 0 and 100
							 .range([ bh+20, padding+20]);

		 yAxis = d3.axisLeft()
				 .tickSize(0, 5)
				 .scale(yScale);

			barSvg.selectAll("rect")
						.data(bData)
						.attr("y", function(d){
							  return yScale(selectYear(year, d))-padding;
						})
						.attr("height", function(d, i){
							return bh-yScale(selectYear(year, d));
						});

			barSvg.select(".yaxis")
					.attr("transform", "translate("+ 40 + ", " + -padding +  ")")
          .call(yAxis)

		}

      d3.json("USA.json", function(json){
        mapsvg.selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
						.attr("id", function(d){
							if(d.properties.name.indexOf(' ') >= 0){
								return d.properties.name.replace(/\s/g, "_");
							}else{
								return d.properties.name
							}
						})
						.attr("class", "state")
            .attr("d", path)
            .attr("z-index", 1)



      });



			d3.csv("data.csv", function(data){
				dataset = data;
				barDataset = data;

				makeVis();
				updatePaths();


			});



		</script>


	</body>
</html>
